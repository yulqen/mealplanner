{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>{% block title %}Meal Planner{% endblock %}</title>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <link href="{% static 'core/css/styles.css' %}" rel="stylesheet">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="icon" type="image/png" href="{% static 'img/logo.png' %}">
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-50 min-h-screen pb-16 sm:pb-0" x-data="{ mobileMenuOpen: false }">
    <!-- Top Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-14 sm:h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="{% url 'home' %}" class="flex items-center text-lg sm:text-xl font-semibold text-gray-900">
                        <img src="{% static 'img/logo.png' %}" alt="Meal Planner Logo" class="h-8 w-8 mr-2">
                        <span>Meal Planner</span>
                    </a>
                </div>

                <!-- Desktop Navigation -->
                {% if user.is_authenticated %}
                <div class="hidden sm:flex sm:items-center sm:space-x-6">
                    <a href="{% url 'recipe_list' %}" class="text-sm font-medium text-gray-700 hover:text-indigo-600 transition-colors">
                        Recipes
                    </a>
                    <a href="{% url 'ingredient_list' %}" class="text-sm font-medium text-gray-700 hover:text-indigo-600 transition-colors">
                        Ingredients
                    </a>
                    <a href="{% url 'plan_list' %}" class="text-sm font-medium text-gray-700 hover:text-indigo-600 transition-colors">
                        Plans
                    </a>
                    <a href="{% url 'shopping_list_current' %}" class="text-sm font-medium text-gray-700 hover:text-indigo-600 transition-colors">
                        Shopping
                    </a>
                    <div class="h-6 w-px bg-gray-200"></div>
                    <span class="text-sm text-gray-500">{{ user.username }}</span>
                    <a href="{% url 'logout' %}" class="text-sm text-gray-500 hover:text-gray-900">Logout</a>
                </div>
                {% else %}
                <div class="flex items-center">
                    <a href="{% url 'login' %}" class="text-sm text-gray-500 hover:text-gray-900">Login</a>
                </div>
                {% endif %}

                <!-- Mobile menu button -->
                {% if user.is_authenticated %}
                <div class="flex items-center sm:hidden">
                    <button @click="mobileMenuOpen = !mobileMenuOpen"
                            type="button"
                            class="inline-flex items-center justify-center p-2 rounded-md text-gray-500 hover:text-gray-900 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500"
                            aria-expanded="false">
                        <span class="sr-only">Open main menu</span>
                        <!-- Hamburger icon -->
                        <svg x-show="!mobileMenuOpen" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                        <!-- Close icon -->
                        <svg x-show="mobileMenuOpen" x-cloak class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Mobile dropdown menu -->
        {% if user.is_authenticated %}
        <div x-show="mobileMenuOpen"
             x-cloak
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 -translate-y-1"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 -translate-y-1"
             @click.away="mobileMenuOpen = false"
             class="sm:hidden bg-white border-t border-gray-100 shadow-lg">
            <div class="px-4 py-3 space-y-1">
                <a href="{% url 'recipe_list' %}" class="block px-3 py-3 rounded-lg text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-indigo-600">
                    ðŸ“– Recipes
                </a>
                <a href="{% url 'ingredient_list' %}" class="block px-3 py-3 rounded-lg text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-indigo-600">
                    ðŸ¥• Ingredients
                </a>
                <a href="{% url 'plan_list' %}" class="block px-3 py-3 rounded-lg text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-indigo-600">
                    ðŸ“… Plans
                </a>
                <a href="{% url 'shopping_list_current' %}" class="block px-3 py-3 rounded-lg text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-indigo-600">
                    ðŸ›’ Shopping
                </a>
                <div class="border-t border-gray-100 mt-2 pt-2">
                    <div class="flex items-center justify-between px-3 py-2">
                        <span class="text-sm text-gray-500">Signed in as {{ user.username }}</span>
                        <a href="{% url 'logout' %}" class="text-sm font-medium text-indigo-600 hover:text-indigo-800">Logout</a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </nav>

    <div
        x-data="toastManager()"
        x-init="init()"
        class="fixed z-50 inset-x-0 top-1/2 -translate-y-1/2 flex flex-col items-center space-y-2 px-4 sm:inset-auto sm:top-4 sm:right-4 sm:translate-y-0 sm:items-end"
        aria-live="polite"
        aria-atomic="true"
    >
        <template x-for="toast in toasts" :key="toast.id">
            <div
                x-show="toast.visible"
                x-transition:enter="transform transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-2 sm:translate-x-2"
                x-transition:enter-end="opacity-100 translate-y-0 sm:translate-x-0"
                x-transition:leave="transform transition ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-y-0 sm:translate-x-0"
                x-transition:leave-end="opacity-0 translate-y-2 sm:translate-x-2"
                class="pointer-events-auto w-full sm:w-auto max-w-sm rounded-lg border px-4 py-3 shadow-lg flex items-start gap-3 text-sm"
                :class="toastClasses(toast.type)"
                role="status"
                x-cloak
            >
                <div class="mt-0.5">
                    <svg x-show="toast.type === 'success'" x-cloak class="w-5 h-5" :class="iconClasses(toast.type)" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z" />
                    </svg>
                    <svg x-show="toast.type === 'error'" x-cloak class="w-5 h-5" :class="iconClasses(toast.type)" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <svg x-show="toast.type === 'warning'" x-cloak class="w-5 h-5" :class="iconClasses(toast.type)" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v4m0 4h.01M10.29 3.86l-8.01 13.86A1 1 0 0 0 3.12 19h17.76a1 1 0 0 0 .84-1.52L13.71 3.86a1 1 0 0 0-1.72 0z" />
                    </svg>
                    <svg x-show="toast.type === 'info'" x-cloak class="w-5 h-5" :class="iconClasses(toast.type)" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9h.01M11 12h2v5m-1 4a10 10 0 1 0 0-20 10 10 0 0 0 0 20z" />
                    </svg>
                </div>
                <div class="font-medium leading-5" x-text="toast.message"></div>
            </div>
        </template>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-4 sm:py-6 px-4 sm:px-6 lg:px-8">
        {% block content %}{% endblock %}
    </main>

    <!-- Mobile Bottom Navigation (quick access) -->
    {% if user.is_authenticated %}
    <nav class="sm:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40">
        <div class="grid grid-cols-4 h-16">
            <a href="{% url 'recipe_list' %}" class="flex flex-col items-center justify-center text-gray-600 hover:text-indigo-600 active:bg-gray-100">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
                <span class="text-xs mt-1">Recipes</span>
            </a>
            <a href="{% url 'plan_list' %}" class="flex flex-col items-center justify-center text-gray-600 hover:text-indigo-600 active:bg-gray-100">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span class="text-xs mt-1">Plans</span>
            </a>
            <a href="{% url 'shopping_list_current' %}" class="flex flex-col items-center justify-center text-gray-600 hover:text-indigo-600 active:bg-gray-100">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                <span class="text-xs mt-1">Shopping</span>
            </a>
            <a href="{% url 'ingredient_list' %}" class="flex flex-col items-center justify-center text-gray-600 hover:text-indigo-600 active:bg-gray-100">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                <span class="text-xs mt-1">Ingredients</span>
            </a>
        </div>
    </nav>
    {% endif %}

    <!-- Hide Alpine.js elements until loaded -->
    <style>
        [x-cloak] { display: none !important; }
    </style>

    <script>
        function toastManager() {
            return {
                toasts: [],
                nextId: 0,
                recentToasts: {},
                init() {
                    this.bindHtmx();
                    this.seedToasts();
                },
                bindHtmx() {
                    if (!window.htmx) return;
                    document.body.addEventListener("htmx:afterRequest", (event) => {
                        const xhr = event.detail.xhr;
                        const header = xhr.getResponseHeader("HX-Trigger");
                        if (!header) return;
                        if (xhr.__toastHandled) return;
                        xhr.__toastHandled = true;
                        this.handleTriggerHeader(header);
                    });
                },
                seedToasts() {
                    const seeded = [{% for message in messages %}{
                        message: "{{ message|escapejs }}",
                        type: "{{ message.tags|default:'info' }}",
                    }{% if not forloop.last %},{% endif %}{% endfor %}];
                    seeded.forEach((toast) => {
                        if (toast.message) {
                            this.addToast(toast.message, toast.type);
                        }
                    });
                },
                handleTriggerHeader(header) {
                    const triggers = this.parseTriggerHeader(header);
                    const payload = triggers.showToast;
                    if (!payload) return;
                    const list = Array.isArray(payload) ? payload : [payload];
                    list.forEach((item) => {
                        if (item && item.message) {
                            this.addToast(item.message, item.type || "info");
                        }
                    });
                },
                parseTriggerHeader(header) {
                    if (!header) return {};
                    const trimmed = header.trim();
                    const jsonStart = trimmed.indexOf("{");
                    if (jsonStart !== -1) {
                        const jsonString = trimmed.slice(jsonStart);
                        try {
                            return JSON.parse(jsonString);
                        } catch (error) {
                            return {};
                        }
                    }
                    const triggers = {};
                    trimmed.split(",").forEach((part) => {
                        const key = part.trim();
                        if (key) {
                            triggers[key] = true;
                        }
                    });
                    return triggers;
                },
                addToast(message, type) {
                    const normalized = this.normalizeType(type);
                    const key = `${normalized}:${message}`;
                    const now = Date.now();
                    const lastSeen = this.recentToasts[key];
                    if (lastSeen && now - lastSeen < 4000) {
                        return;
                    }
                    this.recentToasts[key] = now;
                    const toast = {
                        id: this.nextId++,
                        message,
                        type: normalized,
                        visible: true,
                    };
                    this.toasts.push(toast);
                    setTimeout(() => this.dismissToast(toast.id), 3000);
                },
                dismissToast(id) {
                    const toast = this.toasts.find((item) => item.id === id);
                    if (!toast) return;
                    toast.visible = false;
                    setTimeout(() => {
                        this.toasts = this.toasts.filter((item) => item.id !== id);
                    }, 250);
                },
                normalizeType(type) {
                    const normalized = (type || "").toString().toLowerCase();
                    if (normalized.includes("error")) return "error";
                    if (normalized.includes("warning")) return "warning";
                    if (normalized.includes("success")) return "success";
                    if (normalized.includes("info")) return "info";
                    return "info";
                },
                toastClasses(type) {
                    const map = {
                        success: "border-emerald-200 bg-emerald-50 text-emerald-900",
                        error: "border-red-200 bg-red-50 text-red-900",
                        warning: "border-amber-200 bg-amber-50 text-amber-900",
                        info: "border-blue-200 bg-blue-50 text-blue-900",
                    };
                    return map[type] || map.info;
                },
                iconClasses(type) {
                    const map = {
                        success: "text-emerald-500",
                        error: "text-red-500",
                        warning: "text-amber-500",
                        info: "text-blue-500",
                    };
                    return map[type] || map.info;
                },
            };
        }
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
